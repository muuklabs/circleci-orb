description: >
  MuukTest Selenium executor with Circle CI on Github.

docker:
  - image: cimg/python:3.7-browsers
    environment:
      GRADLE_OPTS: -Xmx1024m -XX:MaxMetaspaceSize=256m
      GRADLE_USER_HOME: .gradle-home

parameters:

  t:
    type: string
    description: "Test case id or hashtag name."

  p:
    type: enum
    default: tag
    enum: [tag, hashtag]
    description: "Set either tag or hastag according value on t parameter."

  browser:
    type: enum
    default: chrome
    enum: [chrome, firefox]
    description: "Set either from chrome or firefox to run the script on."

  muuk_key:
    default: MUUKTEST_KEY
    description: "Name of the env var with your MuukTest key.pub account value. This var should be set on CircleCi settings."
    type: env_var_name

resource_class: medium+

steps:
  - run:
      name: Init
      command: |
        MUUKTEST_KEY_INTERNAL=${<< parameters.muuk_key >>}
        printf "%s" "$MUUKTEST_KEY_INTERNAL" > key.pub
        cat key.pub

  - run:
      name: Install required libraries
      command: <<include(scripts/install_mkcli_requirements.sh)>>

  - run:
      name: Get MuukTest executor and run tests
      command: <<include(scripts/configure_mkcli.sh)>>

  - run:
      name: Execute E2E tests and report results to MuukTest
      command: |
        cd executor/
        python3 mkcli.py -p << parameters.p >> -t << parameters.t >> -browser << parameters.browser >>
